---
title: "Track-a-cohort: figures"
output: 
  html_document:
    code_folding: hide
    theme: sandstone
date: "2024-05-24"
---

#  {.tabset}

**Background**

Objective: Using shared resources via [BDO github](https://github.com/BDO-Science/track-a-cohort), include more interactive capabilities to certain graphs in form of Rmarkdown and/or shinyapp and update underlying data sources. See 
[Track a cohort_WR_plots.docx](https://github.com/BDO-Science/track-a-cohort/blob/main/Track%20a%20Cohort_WR_plots.docx) for all figures requested. 


```{r load_libraries, include=FALSE, warning=FALSE, message=FALSE}
library(here) #to designate file pathways
library(tidyverse) #data manipulation, includes pkgs such as lubridate and ggplot
library(gghighlight) #for stars plot- highlight certain years
library(plotly) #for interactive plots
library(ggrepel) #for ggplot labels
library(xts) #NB code to import STARs data
library(patchwork) #arrange plots

#“lumen”, “paper”, “readable”, “sandstone”, “simplex”, “spacelab”, “united”, “yeti”
```


**Current Figures**



## Fig 3. Juvenile Production Estimate Loss 


```{r import_loss_data, include=FALSE}
#url <- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no"
url<- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=default&year=all&species=1%3Af&dnaOnly=no&age=no"

#filter to include only winter-run chinook for LAD or winter-run for DNA
loss.wch <- read.csv(url) %>%
  filter(LAD.Race == 'Winter'| DNA.Race == 'Winter') 
  
#adjust imported loss to WY 
df_loss <- loss.wch %>% select(Sample.Time, Facility, LAD.Race, DNA.Race, Length, nfish, Expanded.Salvage, Loss) %>%
  mutate(Date = as.Date(Sample.Time)) %>%
  arrange(Date) %>%
  mutate(WY = year(Date) + (month(Date) >= 10),
         wDay = if_else(month(Date) >= 10, yday(Date) - 273, yday(Date) + 92),
         doy = yday(Date),
         CY = year(Date),
         wDate = if_else(month(Date) >= 10, Date + years(1), Date))

#summarize loss to later calculate pct loss per 
df_ladloss_sum<-df_loss %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise( nfish = sum (nfish),
             nloss = sum(Loss),
             nsalvage = sum(Expanded.Salvage))%>% 
  mutate(losstype = "LAD")

df_dnaloss_sum<-df_loss %>% 
  filter(DNA.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise( nfish = sum (nfish),
             nloss = sum(Loss),
             nsalvage = sum(Expanded.Salvage)) %>% 
  mutate(losstype = "DNA")

df_loss_sum <-rbind(df_ladloss_sum, df_dnaloss_sum)

#import JPE estimates
jpe_url<- "https://www.cbr.washington.edu/sacramento/data/graphics/jpedata_Natural_1.txt"
#assign WY for each letter (one year ahead of broodyear)
df_jpe<-read.csv(jpe_url, sep = "|") %>% 
  mutate(WY = brood_year + 1)

#join JPE totals with loss
df_loss_sum <- df_loss_sum %>% 
  inner_join(select(df_jpe,WY,brood_year, "method" = references_contributors,  "JPE" = value ), by = "WY" ) %>% 
  mutate(method = factor(method, levels = c("Method 2 (O’Farrell et al 2018) with data from USFWS, UC Santa Cruz, and SWFSC", "NA"), labels = c("Method 2 (O'Farrell et al., 2018)", NA)))

df_loss_sum<-df_loss_sum %>% 
  group_by(WY, losstype) %>% 
  mutate(pctloss = (nloss/JPE))
```

### Figure 3a. Comparing Genetic vs Length-At-Date (LAD) Percent JPE Loss 

```{r p_jpe_genetic_loss_pct, fig.width=10, echo = FALSE, warning = FALSE, message=FALSE}
#pull in JPES and genetic loss data
 JPE_Genetic_Loss_Comparison<- read_csv(here::here('track-a-cohort/shared files/JPE_Genetic_Loss_Comparison.csv'))


jpe_long <- JPE_Genetic_Loss_Comparison %>% 
  select(WaterYear,BroodYear,JuvenileProductionEstimate,PercentJPE_genetic,PercentJPE_LAD) %>% 
  # rename(`Juvenile Production Estimate`= JuvenileProductionEstimate,`Percent JPE Genetic Loss` = PercentJPE_genetic, `Percent JPE LAD Loss`= PercentJPE_LAD) %>% 
  pivot_longer(cols =PercentJPE_genetic:PercentJPE_LAD, names_to = "method", values_to = "value")

#bar plot of genetic and LAD loss
p_tac <- 
  ggplot(data=jpe_long, aes(x=as.factor(BroodYear), y= value, fill=method)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(x = "Brood Year", 
       y = "Percent of JPE Loss", #change title
       fill = NULL) +
  scale_y_continuous(breaks = seq(0, 6, by = 2), limits = c(0, 6), expand = c(0, 0))+
  scale_fill_manual(values = c("black", "grey"),
                    labels = c("Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65), 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(), 
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"), 
          text = element_text(size = 15))

p_tac
```

### Figure 3b. Comparing Genetic vs Length-At-Date (LAD) Number of JPE Loss
```{r p_jpe_genetic_loss_count, fig.width=10, echo = FALSE, warning=FALSE, message=FALSE}
#pull in JPES and genetic loss data
 JPE_Genetic_Loss_Comparison<- read_csv(here::here('track-a-cohort/shared files/JPE_Genetic_Loss_Comparison.csv'))


jpe_long <- JPE_Genetic_Loss_Comparison %>% 
  select(WaterYear,BroodYear,JuvenileProductionEstimate,LAD = WinterRun_LAD_Loss,Genetic = WinterRun_Genetic_Loss) %>% 
  # rename(`Juvenile Production Estimate`= JuvenileProductionEstimate,`Percent JPE Genetic Loss` = PercentJPE_genetic, `Percent JPE LAD Loss`= PercentJPE_LAD) %>% 
  pivot_longer(cols =LAD:Genetic, names_to = "method", values_to = "value")



#bar plot of genetic and LAD loss
p <- 
  ggplot(data=jpe_long, aes(x=as.factor(BroodYear), y= value, fill=method)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(x = "Brood Year", 
       y = "Number of JPE loss", #change title
       fill = NULL) +
  scale_y_continuous(breaks = seq(0, 21000, by = 5000), limits = c(0, 21000), expand = c(0, 0))+
  scale_fill_manual(values = c("black","grey" ),
                    breaks = c("Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65), 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(), 
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"), 
          text = element_text(size = 15))

p
```


```{r p_cbr, eval=FALSE, include=FALSE, fig.show='hold', out.width='50%'}
 ggplot(data=df_loss_sum, aes(x=as.factor(brood_year), y= pctloss*100, fill=losstype, color = method)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(x = "Brood Year", 
       y = "Percent of JPE Loss", #change title
       fill = NULL) +
  # scale_y_continuous(breaks = seq(0, 6, by = 2), limits = c(0, 6), expand = c(0, 0))+
  scale_fill_manual(values = c("black" , "grey"),
                    labels = c("DNA" = "Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(),
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"),
          text = element_text(size = 15))


 ggplot(data=df_loss_sum, aes(x=as.factor(brood_year), y= nloss, fill=losstype)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(x = "Brood Year", 
       y = "JPE Loss", #change title
       fill = NULL) +
  # scale_y_continuous(breaks = seq(0, 6, by = 2), limits = c(0, 6), expand = c(0, 0))+
  scale_fill_manual(values = c("black", "grey"),
                    labels = c("DNA" = "Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(),
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"),
          text = element_text(size = 15))
 

```


---

Questions/Concerns: 

  - Add color to bar plot for differing JPE years, especially pre-2004.
  
  - data source for genetic data? Similar questions regarding how to distinguish differing methods throughout years
  
  - data source for LAD loss? 
  
  



## Fig 4. Cumulative Loss
### Figure 4. Current and Historical Cumulative Loss (Shared)

```{r fig3b_shared_code, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
library(busdater)
url_orig <- 'https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no'
url <- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no"
loss <- read.csv(url) %>%
  filter(LAD.Race == 'Winter'| DNA.Race == 'Winter')

waterDay<-readRDS(here::here("track-a-cohort/shared files/waterDay.rds"))

wytype <- read.csv(here::here('track-a-cohort/shared files/WYtype.csv'))%>% filter(Basin == "SacramentoValley") 
loss <- loss %>% select(Date = 1, 2, 5, 6, 11, 12, ExpSalv = 13, 14) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(WY = get_fy(Date, opt_fy_start = '10-01')) %>%
  mutate(wDay = waterDay(Date))

cumulativeLAD <- loss %>% filter(LAD.Race == 'Winter') %>% group_by(WY) %>%
  mutate(cumloss = cumsum(Loss), cumsalvage = cumsum(ExpSalv), cumCount = cumsum(nfish)) %>%
  mutate(Status = case_when(WY < 2009 ~ 'Pre-2009 BiOp',
                            WY > 2008 ~ '2009 & 2019 BiOp')) %>%
  left_join(wytype, by = 'WY') %>%
  filter(!is.na(Date)) %>%
  mutate(History = if_else(WY == '2024', 'Current', 'Past')) %>%
  mutate(Type2 = if_else(Yr.type %in% c('W', 'AN'), 'Wet', 'Dry')) %>%
  mutate(Status = factor(Status, levels = c('Pre-2009 BiOp', '2009 & 2019 BiOp')))


yearsLAD <- cumulativeLAD %>% group_by(WY, Status, Yr.type, Type2) %>% summarize(Day = max(wDay), Loss = max(cumloss))
max2024LAD <- cumulativeLAD %>% filter(WY == 2024 & cumloss == max(cumloss)) %>% pull(cumloss)
loss2024LAD <- cumulativeLAD %>% filter(WY == 2024) %>% select(10, 11)
label2024 <- data.frame(x = 90, y = 1250, label = '2024')

WR <- ggplot() +
  geom_line(filter(cumulativeLAD, WY < 2024), 
            mapping = aes(x = wDay, y = cumloss, group = factor(WY)), color = 'grey', linewidth = 1)+
  geom_line(loss2024LAD, 
            mapping = aes(x = wDay, y = cumloss), color = 'steelblue2', linewidth = 1.5)+
  geom_text_repel(filter(yearsLAD, Loss > max2024LAD), mapping = aes(x = Day+1, y = Loss, label = WY), 
            size = 3, fontface = 'bold', alpha = 0.75, min.segment.length = .1) +
  facet_grid(Status ~ Type2) +
  labs(x = 'Date', y = 'Cumulative Loss', title = 'Winter-run Current and Historic Cumulative Salvage') +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  theme(plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=10)),
        axis.title.y = element_text(margin=margin(r=10)))
WR
```


```{r fig4_import_wrangle data, echo=FALSE, message=FALSE}

#Further filter to only plot winter-run chinook for LAD
cumulativeLAD <- df_loss %>% filter(LAD.Race == 'Winter') %>% group_by(WY) %>%
  mutate(cumloss = cumsum(Loss)) %>%
  #designate pre/post 2009 BiOp
  mutate(Status = case_when(WY < 2009 ~ 'Pre-2009 BiOp\n(1994 to 2008)',
                            WY > 2008 ~ '2009 & 2019 BiOp\n(2009 to present)')) %>%
  #set order of factor levels
  mutate(Status = factor(Status, levels = c('Pre-2009 BiOp\n(1994 to 2008)', '2009 & 2019 BiOp\n(2009 to present)'))) %>% 
  #join with wytype to designate wet/dry year (Hydrologic Classification Index?)
  left_join(select(wytype,WY, "hydro_type" = Yr.type) , by = 'WY') %>%
  #remove date na's
  filter(!is.na(Date)) %>%
  # #label historical versus current year
  # mutate(History = if_else(WY == '2024', 'Current', 'Past')) %>%
  #relabel wytype Yr.type to Wet/Dry -- add all?
  mutate( hydro_type = factor(hydro_type, levels = c("W", "AN", "BN", "D", "C"), labels = c("Wet", "Above Normal", "Below Normal", "Dry", "Critical")))
  
```

### Figure 4a. Current and Historical Cumulative Loss
```{r p_fig4a_all_years, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
#plot

# #set function to 2024?
# day_to_month <- function(day) {
#   month <- as.Date(paste(2024, day), format = "%Y %j") %>% format("%b")
#   return(month)
# }

  # Define all possible levels of hydro_type
  all_levels <- c( "Wet", "Above Normal", "Below Normal", "Dry", "Critical" )
  
  # Create a color palette that includes all possible levels
  color_palette <- setNames(c("darkblue", "cadetblue", "navajowhite3","tan3", "salmon4"), all_levels)

#plot all years together  
p1<-cumulativeLAD %>% 
 ggplot() +
  # geom_line( aes(x = wDay, y = cumloss, group = WY, color = if_else(WY == 2024, "black", ifelse(Type2 == "Dry", "brown", "cadetblue3")),lwd = if_else(WY == 2024, .5, .05)))+
    geom_line( data = subset(cumulativeLAD, WY != 2024), aes(x=wDay, y = cumloss, group = WY, color = hydro_type), lwd = .40)+
  geom_line( data = subset(cumulativeLAD, WY == 2024), aes( x=wDay, y = cumloss, group = WY, linetype = as.factor(WY)), color = "black", lwd = 1.5)+
  labs(x = 'Date', 
       y = 'Cumulative Loss', 
       # title = 'Winter-run Chinook salmon - Current and Historical Cumulative Salvage',
       subtitle = " Data includes: WY1994 to WY2024",
       color = "Hydrological Year Type:",
       linetype = "Current Water Year:") +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  # scale_x_continuous(breaks = seq(1, 365, by = 30.5), labels = day_to_month) +
  scale_y_continuous(breaks = seq(0, 20000, by = 5000), limits = c(0, 20000), expand = c(0, 0))+
  scale_color_manual(values = color_palette,
                     labels = c( "Wet", "Above Normal", "Below Normal", "Dry", "Critical" , "WY2023 unassigned") )+
   guides(linetype = guide_legend(order = 1), color = guide_legend(order = 2)) +
  theme_minimal() +
  theme(legend.position = c(.9, .7),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank(), 
        axis.line.x = element_line(color = "black", .5),
         axis.line.y = element_line(color = "black", .5),
        axis.ticks.x = element_line(color = "black"), 
        text = element_text(size = 15))
p1
```

### Figure 4a. Current and Historical Cumulative Loss by Hydrologic Type and BiOp Year

```{r p_fig4b_facet, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
#plot by dry/wet and pre/post 2009 BiOp

#extract max cumloss of 2024 to adjust color 
max2024LAD <- cumulativeLAD %>% 
  filter(WY == 2024) %>% 
  summarise(max_cumloss = max(cumloss)) %>% 
  pull(max_cumloss)

#extract maximum cumloss for each year (for labels)
max_cumloss_per_year <- cumulativeLAD %>%
  group_by(WY, Status) %>%
  filter(cumloss == max(cumloss))

#Data frame that contains only the data for the year 2001 (for year labels excluding >10,000)
year2001_data <- cumulativeLAD %>% filter(WY == 2001, cumloss < 10000)

p2 <- cumulativeLAD %>%
  filter(Status == "Pre-2009 BiOp\n(1994 to 2008)",
         WY != "2024") %>% 
  filter(cumloss < 10000) %>% 
  ggplot() +
  geom_line(aes(x = wDay, y = cumloss, group = WY, color = hydro_type)) + #, color = if_else(WY == 2024, "black", if_else(cumloss > max2024LAD, "black", hydro_type)))) +
  geom_hline(yintercept = max2024LAD, linetype = "dashed", color = "black") +
    geom_text(data = . %>% filter(hydro_type == "Critical"), aes(x = 170, y = max2024LAD, label = "WY2024 cumulative loss"), size = 3, fontface = "plain", vjust = -1) +
  ggrepel::geom_text_repel(data = subset(max_cumloss_per_year, cumloss >= max2024LAD & between(WY, 1994, 2008)), aes(x = wDay, y = cumloss, label = WY), size = 3,  nudge_y = 10, nudge_x = 2) +
  geom_text(data = year2001_data, aes(x = 180, y = 9000, label = "*2001\nmax value = 20062"), size = 3,fontface = "plain") +
  labs(x = NULL, 
       y = 'Cumulative Loss', 
       # title = 'Winter-run Chinook salmon -  Current and Historical Cumulative Salvage',
       subtitle = "Pre-2009 BiOp years: 1994 to 2008") +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  scale_y_continuous(breaks = seq(0, 10000, by = 2000), limits = c(0, 10000), expand = c(0, 0)) +
  scale_color_manual(values = color_palette) +
    facet_grid(~hydro_type) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA),
    axis.ticks.x = element_line(color = "black"), 
    text = element_text(size = 15))


p3<-  cumulativeLAD %>%
  filter(Status == "2009 & 2019 BiOp\n(2009 to present)",
          !WY %in% c("2023","2024")) %>% 
  filter(cumloss < 10000) %>% 
  ungroup() %>% 
 add_row(WY = NA, Status = NA, hydro_type = "Above Normal", cumloss = NA, wDay = NA) %>%
  mutate(hydro_type = factor(hydro_type, levels = c("Wet", "Above Normal", "Below Normal", "Dry", "Critical"))) %>%
  ggplot() +
  geom_line(aes(x = wDay, y = cumloss, group = WY, color = hydro_type)) +  #, color = if_else(WY == 2024, "black", if_else(cumloss > max2024LAD, "black", hydro_type)))) +
  geom_hline(yintercept = max2024LAD, linetype = "dashed", color = "black") +
  geom_text(data = . %>% filter(hydro_type == "Critical"), aes(x = 170, y = max2024LAD, label = "WY2024 cumulative loss", fontface = "plain"), size = 3, vjust = -1) +
  ggrepel::geom_text_repel(data = subset(max_cumloss_per_year, cumloss >= max2024LAD & between(WY, 2009, 2023) ), aes(x = wDay, y = cumloss, label = WY), size = 3,  nudge_y = 10, nudge_x = 2) +
  labs(x = 'Date', 
       y = 'Cumulative Loss', 
       title = NULL,
       subtitle = "2009 & 2019 BiOp years: 2009 to 2022",
       color = "Hydrologic Classification Indice") +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  scale_y_continuous(breaks = seq(0, 10000, by = 2000), limits = c(0, 10000), expand = c(0, 0)) +
  scale_color_manual(values = color_palette) +
  facet_grid(~hydro_type) +
  theme_minimal() +
  theme(legend.position = "none",
    panel.grid.minor.x = element_blank(), 
    panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA),
    axis.ticks.x = element_line(color = "black"), 
    text = element_text(size = 15))



p <- p2/p3

p 



```

---

Questions: 

- TAC doc shared indicates salvage in title-- wanting salvage and loss? Possibly Shiny option to turn on/off levels.

- Keep CDEC naming or 5 hydro classifications or set all to either "Dry" or "Wet"? Further highlight just "Dry" years?

- Plot current WY over all years of data or include a moving dashed line?

- Include indices that are not currently assigned (ex. WY2023)

- Data source? query from : https://www.cbr.washington.edu/sacramento/data/query_loss_detail.html with all years, species, and no LAD age restriction, but  requires dna?



## Fig 6. Loss - Single-Year Thresholds
```{r import_code_shared,  echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(busdater)
library(patchwork)
library(rvest)
#set source folder, destination folder, and read in most recent salmon and steelhead files
#pulling in most recent steelhead salvage
url <- "https://filelib.wildlife.ca.gov/Public/salvage/Salmon%20Monitoring%20Team/" #salvage files url
page <- read_html(url) #read url in
links <- page %>% html_nodes("a") %>% html_attr("href") # Extract all links from the webpage
salmon_links <- links[grep("salmon_", links, ignore.case = TRUE)]  # Select files containing "salmon_"
salmon_links <- salmon_links[!grepl("summary", salmon_links, ignore.case = TRUE)]  # Exclude files containing "summary"
salmon_links <- salmon_links[!grepl("table", salmon_links, ignore.case = TRUE)] # Exclude files containing "table"
file <- max(grep("\\.csv$", salmon_links, value = TRUE, ignore.case = TRUE)) #isolate the most recent salmon salvage table

#read in salmon salvage file
salmon <- read.csv(paste0('https://filelib.wildlife.ca.gov/',file)) %>%
  mutate(SampleDate = as.Date(SampleDate))

#summarize genetic daily limit exceedance. Resulting table is Table 1.
daily_trigger <- salmon %>% filter(DNA_Race == 'W') %>%
  group_by(SampleDate) %>% summarize(Loss = sum(LOSS, na.rm = TRUE)) %>%
  mutate(Perc_JPE = (Loss/234896)*100) %>%
  mutate(Threshold = case_when(month(SampleDate) == 1 ~ .00124, #add in daily trigger limit by month
                              month(SampleDate) == 2 ~ .00231,
                              month(SampleDate) == 3 ~ .00372,
                              month(SampleDate) == 4 ~ .00226,
                              month(SampleDate) == 5 ~ 0)) %>%
  mutate(Trigger = if_else(Perc_JPE > Threshold, 'Y', 'N')) #check if genetic loss exceeds daily trigger


#filtering for LAD WR and Genetic WR and recombining into dataframe for graph
salmonLAD <- salmon %>% 
  filter(ADCLIP == 'N', Size_Race == 'W') %>%
  select(Date = 2,13) %>% 
  replace(is.na(.), 0) %>% 
  mutate(cumlost = cumsum(LOSS)) %>%
  mutate(Type = 'Length at Date')
salmonGen <- salmon %>%
  filter(ADCLIP == 'N', DNA_Race == 'W') %>%
  select(Date = 2,13) %>% 
  replace(is.na(.), 0) %>% 
  mutate(cumlost = cumsum(LOSS)) %>%
  mutate(Type = 'Genetic') %>% 
  bind_rows(tibble(Date = max(salmonLAD$Date), 
                   LOSS = max(.$LOSS),
                   cumlost = max(.$cumlost), 
                   Type = 'Genetic'))
salmonAll <- bind_rows(salmonLAD, salmonGen)
```
```{r shared_plot_code_1,warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#graph for LAD salmon
SalthresholdsLAD <- data.frame(Thresholds = c('50%', '75%', '100%', 'Single-year ITL (2% of JPE)'), values = c(1374, 2061, 2748, 4698))


salmonmax <- salmonAll %>% group_by(Type) %>% summarize(Date = max(Date), cumlost = max(cumlost))
Sal1 <- ggplot() + 
  geom_line(filter(salmonAll, Type == 'Length at Date'), 
            mapping = aes(x = Date, y = cumlost), 
            linewidth = 1,
            color = 'steelblue3') + 
  geom_hline(SalthresholdsLAD, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsLAD, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (LAD)', '75%', 
                                                      '100%', 'Single-year ITL (2% of JPE)')), 
            fontface = 'bold', vjust = 1.4, size = 3, color = '#333333', hjust=0) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3) +
  geom_label(filter(salmonmax, Type == 'Length at Date'), mapping = aes(x = Date + 1, y = cumlost+150,
                                                                        label = paste0(cumlost,
                                                                                       ' (',round(((cumlost/4698)*100),1),'%)')), size = 3) +
  labs(y = 'Cumulative Loss', x = 'Date', title = 'Winter-run LAD Loss') + 
  scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000, ceiling), 500)) +
  scale_x_date(date_breaks = '3 weeks', date_labels = "%b %d", limits = c(as.Date('2024-01-01'), Sys.Date() + 14)) +
  guides(linetype = FALSE) +
  theme(legend.position = 'none',
        plot.margin = margin(0.2,0.2,0.2,0.2, unit = 'cm'),
        axis.title.y = element_text(margin=margin(r=15), size = 15),
        axis.title.x = element_text(margin=margin(t=15), size = 15))
Sal1
```


```{r import_salvage_data_cbr, eval=FALSE, include=FALSE}
#currently works off of link previously generated that pull all years of loss and salvage data-- this further filters to the current water year (i.e., CY =2024, pulls 10-1-23 to 9-30-24)

# Get the current year
current_year <- year(Sys.Date())

# Specify the start and end dates
start_date <- as.Date(paste0(current_year - 1, "-10-01"))
end_date <- as.Date(paste0(current_year, "-09-30"))

# extract JPE current loss year --needs automatiu
JPE_currentyear<-df_jpe%>% filter(WY == current_year) %>% pull(value)

# Filter the data
df_loss_current_year <- df_loss %>%
  filter(Date >= start_date & Date <= end_date) %>% 
  filter(DNA.Race == "Winter" | LAD.Race == "Winter")

# Calculate the daily trigger
df_trigger <- df_loss_current_year %>%
  group_by(Date) %>% summarize(loss = sum(Loss, na.rm = TRUE)) %>%
  #divide loss by current year JPE to get percent JPE loss
  mutate(pctJPE = (loss/JPE_currentyear)*100) %>%
  #where are these daily triggers being selected from?
  mutate(threshold = case_when(month(Date) == 1 ~ .00124, #add in daily trigger limit by month
                              month(Date) == 2 ~ .00231,
                              month(Date) == 3 ~ .00372,
                              month(Date) == 4 ~ .00226,
                              month(Date) == 5 ~ 0)) %>%
  #designate if genetic loss exceeds daily trigger
  mutate(trigger = if_else(pctJPE > threshold, 'Y', 'N')) 

#calculate cumulative loss for LAD and Genetic
df_lad_cum_loss<-df_loss_current_year %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(Date) %>% 
  summarise(sum.loss = sum(Loss)) %>% 
  mutate(cumloss = cumsum(sum.loss),
         type = "LAD")

df_dna_cum_loss<-df_loss_current_year %>% 
  filter(DNA.Race == "Winter") %>% 
  group_by(Date) %>% 
  summarise(sum.loss = sum(Loss)) %>% 
  mutate(cumloss = cumsum(sum.loss),
         type = "DNA")
  
 df_combined <- bind_rows(df_lad_cum_loss, df_dna_cum_loss) 
```


```{r set_thresholds, eval = FALSE, include=FALSE}
JPE_2024_02<-round(JPE_currentyear * .02) 

JPE_2024_1.3<-(sum(234896 + 49924 + 125038)/3)*.013

JPE_2024_1.7<-(sum(234896 + 49924 + 125038)/3)*.017

round(JPE_currentyear*.017)

#get greatest annual loss from 2010-2018:
max_lad_loss<-df_loss %>%
  filter(between(WY, 2010,2018)) %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise(annual_loss = sum(Loss)) %>%
  filter( annual_loss == max(annual_loss)) %>% 
  pull(annual_loss)*.9 #annual threshold is 90% the maximum annual loss from 2010-2018


```

```{r eval = FALSE, include=FALSE}
df_combined %>% 
  ggplot(aes(x = Date, y = cumloss)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  geom_hline(thresholdsLAD, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsLAD, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (LAD)', '75%', 
                                                      '100%', 'Single-year ITL (2% of JPE)')), 
            fontface = 'bold', vjust = 1.4, size = 3, color = '#333333', hjust=0) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3)
  facet_grid(~type)
  theme_minimal()
```




```{r shared_plot_code_2, eval=FALSE, include=FALSE}
#graph for genetic salmon
SalthresholdsGen <- data.frame(Thresholds = c('50%', '75%', '100%'), values = c(592, 888, 1184))
salmonmax <- salmonAll %>% group_by(Type) %>% summarize(Date = max(Date), cumlost = max(cumlost))
Sal2 <- ggplot() + 
  geom_line(filter(salmonAll, Type == 'Genetic'), 
            mapping = aes(x = Date, y = cumlost), 
            linewidth = 1,
            color = 'steelblue3') + 
  geom_hline(SalthresholdsGen, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsGen, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (Genetic)', '75%', 
                                                      '100%')), 
            fontface = 'bold', vjust = 1.4, color = '#333333', hjust=0, size = 3) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3) +
  geom_label(filter(salmonmax, Type == 'Genetic'), mapping = aes(x = Date + 1, y = cumlost+150,
                                                                 label = paste0(cumlost,
                                                                                ' (',round(((cumlost/1184)*100),1),'%)')), size = 3) +
  labs(y = 'Cumulative Loss', title = 'Winter-run Genetic Loss') + 
  scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000), 100), limits = c(0, 1200)) +
  scale_x_date(date_breaks = '3 weeks', date_labels = "%b %d", limits = c(as.Date('2024-01-01'), Sys.Date() + 14)) +
  guides(linetype = FALSE) +
  theme(legend.position = 'none',
        plot.margin = margin(0.2,0.2,0.2,0.2, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=15), size = 15))
Sal2
```


```{r shared_plot_code_combined, eval=FALSE, include=FALSE}
WRGraph <- Sal1|(Sal2 +
                   theme(axis.text.y = element_blank(),
                         axis.title.y = element_blank()) +
                   scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000), 500), 
                                      limits = c(0, max(SalthresholdsLAD$values))))
WRGraph #This is figure 7

```

```{r, eval = FALSE, include=FALSE}

thresholdsLAD <- data.frame(Thresholds = c('50%', '75%', '100%', 'Single-year ITL (2% of JPE)'), values = c(1374, 2061, 2748, 4698))
```


---

Questions:

- Similar to other figures, confirm data source and update to automate

- Monthly and daily triggers data source

- Confirm single-year thresholds displayed: 
  
  - JPE letter: "Loss of natural winter-run Chinook salmon, is 1.3% of the JPE on a three-year rolling average or 2.0% of the JPE in any single year." 
  
  - Add additional levels to toggle on/off in shiny or plotly?
  
  - What is the significance of the -500 flow action?
  



## Fig 2. STARs


```{r, fig.width=10, fig.height=8, warning=FALSE, error=FALSE, message=FALSE}
files <- list.files(path = here::here('track-a-cohort/shared files/STARS/'))
waterDay <- readRDS(here::here('track-a-cohort/shared files/waterDay.rds'))

stars <- read_csv(here::here(paste0('track-a-cohort/shared files/STARS/',files))) %>% bind_rows() %>%
  select(1, surv = 2, survL80 = 3, survU80 = 4, idsurv = 17, idsurvL80 = 18, idsurvU80 = 19, idRoute = 32, idRouteL80 = 33, idRouteU80 = 34) %>% arrange(Date) %>%
  mutate(WY = get_fy(Date, opt_fy_start = '10-01')) %>%
  mutate(wDay = waterDay(Date))


stars2 <- stars %>% select(12,Group = 11,2:10)


stars_graph_surv <- ggplot(stars, mapping = aes(x = wDay)) + 
  geom_line(stars2, mapping = aes(y = surv, group = Group), color = 'grey', linewidth = .5) + 
  geom_line(stars, mapping = aes(y = surv), color = 'steelblue2', linewidth = 1) +
  geom_ribbon(stars, mapping = aes(ymin = survL80, ymax = survU80), fill = 'steelblue2', alpha = 0.5) + 
  facet_grid(WY~.) +
  labs(x = 'Date', y = 'Probability', title = 'STARS Total Survival') +
  scale_x_continuous(breaks = c(1,62,124,183,244), labels = c('Oct', 'Dec', 'Feb', 'Apr', 'Jun'), limits = c(0,272)) +
  theme(legend.position = 'none',
        plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=10)),
        axis.title.y = element_text(margin=margin(r=10)),
        title = element_text(size = 10))





stars_graph_route <- ggplot(stars, mapping = aes(x = wDay)) + 
  geom_line(stars2, mapping = aes(y = idRoute, group = Group), color = 'grey', linewidth = .5) + 
  geom_line(stars, mapping = aes(y = idRoute), color = '#009933', linewidth = 1) +
  geom_ribbon(stars, mapping = aes(ymin = idRouteL80, ymax = idRouteU80), fill = '#009933', alpha = 0.5) + 
  facet_grid(WY~.) +
  labs(x = 'Date', y = 'Routing Probability', title = 'STARS Interior Delta Routing Probability') +
  scale_x_continuous(breaks = c(1,62,124,183,244), labels = c('Oct', 'Dec', 'Feb', 'Apr', 'Jun'), limits = c(0,272)) +
  theme(legend.position = 'none',
        plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        title = element_text(size = 10))



stars_graph_IDsurv <- ggplot(stars, mapping = aes(x = wDay)) + 
  geom_line(stars2, mapping = aes(y = idsurv, group = Group), color = 'grey', linewidth = .5) + 
  geom_line(stars, mapping = aes(y = idsurv), color = '#CC6666', linewidth = 1) +
  geom_ribbon(stars, mapping = aes(ymin = idsurvL80, ymax = idsurvU80), fill = '#CC6666', alpha = 0.5) + 
  facet_grid(WY~.) +
  labs(x = 'Date', y = 'Probability', title = 'STARS Interior Delta Survival') +
  scale_x_continuous(breaks = c(1,62,124,183,244), labels = c('Oct', 'Dec', 'Feb', 'Apr', 'Jun'), limits = c(0,272)) +
  theme(legend.position = 'none',
        plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(r=10)),
        title = element_text(size = 10))


graph <- (stars_graph_IDsurv|stars_graph_route)/stars_graph_surv
graph
```

--- 

Questions: 

- Keep as static with updated data or add interactive elements such as hydrologic year (see ShinyApp for options)
