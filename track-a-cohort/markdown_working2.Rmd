---
title: "Track-a-cohort: Figures"
output: 
  html_document:
    code_folding: hide
date: "Updated: 2024-06-12"
---

#  {.tabset}

**Background**

Objective: Using shared resources via [BDO github](https://github.com/BDO-Science/track-a-cohort) from BOR, replicate figures and adjust to include dynamic data. See 
[Track a cohort_WR_plots.docx](https://github.com/BDO-Science/track-a-cohort/blob/main/Track%20a%20Cohort_WR_plots.docx) for figures requested. Also consider future additions including more interactive capabilities to certain graphs in form of Rmarkdown and/or shinyapp

Issues: 

- For all figures -- confirm method used to assign month to plots based on wDay. 

- Update naming to improve accuracy

- update data sources

```{r load_libraries, include=FALSE, warning=FALSE, message=FALSE}
library(here) #to designate file pathways
library(tidyverse) #data manipulation, includes pkgs such as lubridate and ggplot
library(gghighlight) #for stars plot- highlight certain years
library(plotly) #for interactive plots
library(ggrepel) #for ggplot labels
library(xts) #NB code to import STARs data
library(patchwork) #for combining plots
```


**Current figures**

## Figure 1. JPE Estimate

Susannah to prepare data for this figure. 
```{r}
jpe.url<- "https://www.cbr.washington.edu/sacramento/data/graphics/jpedata_Natural_1.txt"

jpe<-data.table::fread(jpe.url)



jpe_annual<- jpe %>% 
  mutate(brood_year = as.factor(brood_year),
         method = str_replace(references_contributors, "Method 2 .*", "Method 2 (O'Farrell et al., 2018)")) %>% 
  ggplot( aes(x=brood_year, y=value, fill = method))+
  geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin = lower_95_CI, ymax =upper_95_CI), width = 0.25)+
  labs(title = "Juvenile Production Estimate (JPE) Winter-run Chinook",
       subtitle = "Natural-origin: Total natural production entering the Delta",
       x = "Brood year", 
       y = "Total number of juvenile fish", 
       fill = "JPE Method")+
   scale_y_continuous( labels= scales::comma, expand = expansion(mult = c(0, 0.05))) +  # Set the lower limit of the y-axis to 0
  scale_fill_manual(values = c("NA" = "grey80", "Method 2 (O'Farrell et al., 2018)" = "grey30"))+
  theme_minimal() +
  theme(legend.position = c(0.8, 0.8),
        axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1), 
        axis.line = element_line(colour = "grey", linewidth = .25), 
        panel.grid.minor.x = element_blank(),
         panel.grid.major.x  = element_blank())
jpe_annual

```


## Figure 2. STARS Delta Survival


```{r stars_shared_code, eval = FALSE, include=FALSE}
#these steps will adjust with NB's help sourcing all years of data to plot figure

#load files--each represents a year of data sourced fom STARS shiny app
files <- list.files(path = here::here('track-a-cohort/shared files/STARS/'))

#convert calendar year to water year via function shared in .rda file--changed to use lubridate
# waterDay <- function(x, start.month = 10L){
#   start.yr = as.integer(format(as.POSIXlt(x), format="%Y")) - 
#     (format(as.POSIXlt(x), format="%m") < start.month)
#   start.date = as.Date(format(ISOdate(
#     year=start.yr, month=start.month, day=1L), format="%Y-%m-%d"))
#   as.integer(x - start.date + 1L)
# }

waterDay <- function(x, start.month = 10L){
  start.yr <- year(x) - (month(x) < start.month)
  start.date <- as.Date(paste0(start.yr, "-", start.month, "-01"))
  as.integer(x - start.date + 1L)
}

#read in files, bind rows, select columns, arrange by date, convert to water year
stars <- read_csv(here::here(paste0('track-a-cohort/shared files/STARS/',files))) %>% bind_rows() %>%
  select(1, surv = 2, survL80 = 3, survU80 = 4, idsurv = 17, idsurvL80 = 18, idsurvU80 = 19, idRoute = 32, idRouteL80 = 33, idRouteU80 = 34) %>% arrange(Date) %>%
  mutate(WY = year(Date) + (month(Date) >= 10)) %>% 
  mutate(wDay = waterDay(Date),
         doy = yday(Date), #added doy/CY for possible shiny app function 
         CY = year(Date),
         wDate = as.Date(paste0(WY, '-', wDay), format = '%Y-%j'))

#shared plot 

##used a subsample of dataset 
stars2 <- stars %>% select(12,Group = 11,2:10)


stars_graph_surv <- ggplot(stars, mapping = aes(x = wDay)) + 
  # geom_line(stars2, mapping = aes(y = surv, group = Group), color = 'grey', linewidth = .5) + 
    geom_line(stars, mapping = aes(y = surv), color = 'steelblue2', linewidth = 1) +
  # geom_ribbon(stars, mapping = aes(ymin = survL80, ymax = survU80), fill = 'steelblue2', alpha = 0.5) + 
  facet_grid(WY~.) +
  labs(x = 'Date', y = 'Probability', title = NULL) +
  scale_x_continuous(breaks = c(1,62,124,183,244), labels = c('Oct', 'Dec', 'Feb', 'Apr', 'Jun'), limits = c(0,272)) +
  theme(legend.position = 'none',
        plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=10)),
        axis.title.y = element_text(margin=margin(r=10)),
        title = element_text(size = 10))
stars_graph_surv
```


```{r import_stars_data, eval = FALSE, include=FALSE}
##alternative method--base plot

#load files--each represents a year of data sourced fom STARS shiny app
files <- list.files(path = here::here('track-a-cohort/shared files/STARS/'))

#alternative wrangling code -- no waterdate fct
df_stars<-read_csv(here::here(paste0('track-a-cohort/shared files/STARS/',files))) %>% 
  bind_rows() %>% 
  select(1, surv = 2, survL80 = 3, survU80 = 4, idsurv = 17, idsurvL80 = 18, idsurvU80 = 19, idRoute = 32, idRouteL80 = 33, idRouteU80 = 34) %>% 
  arrange(Date) %>% 
  mutate(WY = year(Date) + (month(Date) >= 10),
         wDay = if_else(month(Date) >= 10, yday(Date) - 273, yday(Date) + 92),
         doy = yday(Date),
         CY = year(Date),
         wDate = if_else(month(Date) >= 10, Date + years(1), Date))
```
   
```{r import_stars_data_NB shared code, include=FALSE}


# grab.stars.R
# Caitlin request
# COPY/MOVE or link to file:
 # /var/httpd/www/shiny/apps/STARS/STARS.shinyinputs.Rdata
# heads up, this object has class: "xts" and "zoo"

load(here::here("track-a-cohort/STARS.shinyinputs.Rdata")) #COB removed verbose=T to run with here::here

# print(colnames(WR_xts))
# print(head(index(WR_xts)))

# Subset the data and convert to tibble
df_stars_raw <- as_tibble(WR_xts[,c("Survival Interior Delta Est", 
                                "Survival Interior Delta LCL 80", 
                                "Survival Interior Delta UCL 80",
                                "Routing Probability Interior Delta Est",    
                                "Routing Probability Interior Delta LCL 80",
                                "Routing Probability Interior Delta UCL 80",
                                "Survival Overall Est", 
                                "Survival Overall LCL 80",
                                "Survival Overall UCL 80")]) %>%
  # Add the first date as a new column
  mutate(date = index(WR_xts)) %>%
  # Make date the first column
  select(date, everything()) %>%
  rename( surv =  "Survival Overall Est", survL80 =  "Survival Overall LCL 80", survU80 =  "Survival Overall UCL 80", 
          idsurv = "Survival Interior Delta Est", idsurvL80 = "Survival Interior Delta LCL 80", idsurvU80 = "Survival Interior Delta UCL 80", 
          idRoute = "Routing Probability Interior Delta Est", idRouteL80 =  "Routing Probability Interior Delta LCL 80", idRouteU80 =  "Routing Probability Interior Delta UCL 80") %>%
  # convert date to WY, wday
  arrange(date) %>% 
  mutate(WY = year(date) + (month(date) >= 10),
         wDay = if_else(month(date) >= 10, yday(date) - 273, yday(date) + 92),
         doy = yday(date),
         CY = year(date),
         wDate = if_else(month(date) >= 10, date + years(1), date)) 

#skip hydro additions for now
df_stars<-df_stars_raw
```

```{r append_hydro_year, eval=FALSE, include=FALSE}
#pull in shared wytype.csv-- look to automate this process (in progress MC^2)
wytype <- read_csv(here::here('track-a-cohort/shared files/WYtype.csv')) %>% filter(Basin == "SacramentoValley")

df_stars<-df_stars_raw %>% 
  inner_join(select(wytype, WY, hydro_type = `Yr-type`), by = "WY") %>% 
  mutate( hydro_type = factor(hydro_type, levels = c("W", "AN", "BN", "D", "C"), labels = c("Wet", "Above Normal", "Below Normal", "Dry", "Critical")))
```


```{r convert_wday_month, eval=FALSE, include=FALSE}

#reference for how wday was calculated
# wDay = if_else(month(Date) >= 10, yday(Date) - 273, yday(Date) + 92)

# Function to convert wDay to month name
wDay_to_month <- function(wDay) {
  # Adjust the wDay for the water year
  adjusted_wDay <- (wDay + 273) %% 365 + 1
  # Convert the adjusted wDay to a date
  date <- as.Date(paste(2000, adjusted_wDay), format = "%Y %j")
  # Return the month name
  return(format(date, "%b"))
}
  
```


```{r p_static_stars_total_survival, include=FALSE}

p_stars_overall_survival <- ggplot(df_stars, aes(x = wDay, group = WY)) +
  geom_line(aes(y = surv)) +
  labs(x = 'Month\n(Water Year: Oct-Dec of year [t-1], Jan-Sep of year [t])', 
       y = 'Apparent survival probability', 
       title = 'Overall Survival', 
       subtitle = "Overall survival is the median survival of daily cohorts for all routes combined.") +
  scale_x_continuous(breaks = seq(1, 365, by = 61), labels = wDay_to_month( seq(1, 365, by = 61))) + 
  gghighlight(use_direct_label = FALSE) +
  facet_grid(WY~.) +
  geom_ribbon(aes(ymin = survL80, ymax = survU80), alpha = 0.5) +
  theme_minimal() +
  theme(panel.border = element_rect(color = "grey", fill = NA, size = .25),
    panel.grid.minor = element_blank(), 
    panel.grid.major.y = element_blank())

```


```{r p_static_stars_int_survival, include=FALSE}
p_stars_int_survival <- ggplot(df_stars, aes(x = wDay, group = WY)) +
  geom_line(aes(y = idsurv)) +
  labs(x = 'Month\n(Water Year: Oct-Dec of year [t-1], Jan-Sep of year [t])', 
       y = 'Apparent survival probability', 
       title = 'Interior Delta Route-specific Survival Probability', 
       subtitle = "Median route-specific survival of daily cohorts using the Interior Delta route") +
  scale_x_continuous(breaks = seq(1, 365, by = 61), labels = wDay_to_month( seq(1, 365, by = 61))) + 
  gghighlight(use_direct_label = FALSE) +
  facet_grid(WY~.) +
  geom_ribbon(aes(ymin = idsurvL80, ymax = idsurvU80), alpha = 0.5) +
  theme_minimal() +
  theme(panel.border = element_rect(color = "grey", fill = NA, size = .25),
      panel.grid.minor = element_blank(), 
      panel.grid.major.y = element_blank())


```


```{r p_static_stars_route_probability, include=FALSE}

p_stars_route_probability <- ggplot(df_stars, aes(x = wDay, group = WY)) +
  geom_line(aes(y = idsurv)) +
  labs(x = 'Month\n(Water Year: Oct-Dec of year [t-1], Jan-Sep of year [t])', 
       y = 'Route probability', 
       title = 'Interior Delta Route-specific Probability', 
       subtitle = "Proportion of daily cohorts using the Interior Delta route") +
  scale_x_continuous(breaks = seq(1, 365, by = 61), labels = wDay_to_month( seq(1, 365, by = 61))) + 
  gghighlight(use_direct_label = FALSE) +
  facet_grid(WY~.) +
  geom_ribbon(aes(ymin = idsurvL80, ymax = idsurvU80), alpha = 0.5) +
  theme_minimal() +
  theme(panel.border = element_rect(color = "grey", fill = NA, size = .25),
        panel.grid.minor = element_blank(), 
        panel.grid.major.y = element_blank())

```

 
```{r combine_plots, fig.height=15, fig.width=10}
p_stars <- p_stars_overall_survival / (p_stars_int_survival + p_stars_route_probability)


p_stars <- p_stars +  
  plot_annotation(title = "STARS Model - Predicted Winter Run Chinook Salmon daily cohorts passage from Knights Landing to Chipps Island",
                  caption = "Years of data: 2018 to 2024 Data source: STARS Shiny App")

p_stars
```

```{r update_fct}
# Function to convert DOY to month name
wDay_to_month <- function(wDay) {
  # Adjust the DOY for the water year
  adjusted_wDay <- (wDay + 273) %% 365 + 1
  # Convert the adjusted DOY to a date
  date <- as.Date(paste(2000, adjusted_wDay), format = "%Y %j")
  # Return the month name
  return(format(date, "%b"))
}


#currently has reactive title and caption--removed for shiny, see app.r
fct_stars_plot <- function(data, year, metric) {
  
  # Define y variable and ribbon variables based on metric
  y_var <- metric
  ymin_var <- paste0(metric, "L80")
  ymax_var <- paste0(metric, "U80")
  
        # Define title based on metric
  rct_title <- switch(metric,
                  surv = 'STARS model - Overall Survival',
                  idsurv = 'STARS model -Interior Delta Route-specific Survival Probability',
                  idRoute = 'STARS model - Interior Delta Route-specific Probability',
                  'STARS model - Survival')
  
    # Define title based on metric
  rct_caption <- switch(metric,
                  surv = "The solid line shows median survival of daily cohorts of winter run Chinook Salmon\n through the Delta from Knights Landing to Chipps Island for all routes combined.",
                  idsurv = "Route-specific survival of daily cohorts of winter run Chinook Salmon\nthrough the Delta from Knights Landing to Chipps Island.",
                  idRoute = "Proportion of daily cohorts of winter run Chinook Salmon\nthrough the Delta (Knights Landing to Chipps Island) using the Interior Delta route.")
  
        
  #  # Generate the labels for the x-axis
  # labels <- sapply(seq(1, 365, by = 60), function(doy) doy_to_month(doy, year))
  
  
  
  # Plot
  p <- ggplot(data, aes(x = wday, group = year)) +
    geom_line(aes(y = !!sym(y_var))) +
    labs(x = 'Month\n(Water Year: Oct-Dec of year [t-1], Jan-Sep of year [t])',
         y = 'Probability',
         title = rct_title,
         subtitle = "Years of data : 2018 to 2024",
         #losing caption with plotly--see plotly annotation instead
         caption = rct_caption) +
    gghighlight(use_direct_label = FALSE) +
    facet_wrap(as.formula(paste0("~", year))) +
    geom_ribbon(aes(ymin = !!sym(ymin_var), ymax = !!sym(ymax_var)), alpha = 0.5) +
   # scale_x_continuous(breaks = seq(1, 365, by = 60), labels = function(wDay) wday_to_month(wDay)) +
    theme_minimal()

  
  return(p)
}

# Usage:
fct_stars_plot(data = df_stars, year = "WY", metric = "idRoute")
fct_stars_survival_plot(data = df_stars, year = "WY", metric = "idsurv")
fct_stars_survival_plot(data = df_stars, year = "WY", metric = "surv")
```


Function code used to plot along with warning message
```{r fct_p_stars_total_survival, eval = FALSE, include=FALSE}
#function to plot wday or doy with WY or CY-- CY needs adjustment and either probability metric from STARS

# Function to convert day of the year to month label
# day_to_month <- function(x) {
#   date <- as.Date(paste(year(today()), x, 1, sep = "-"), format = "%Y-%j")
#   month(date, label = TRUE)
# }
# Function to convert DOY to month name
doy_to_month <- function(doy, year_type) {
  # Adjust the DOY based on the year type
  adjusted_doy <- if (year_type == "WY") {
    (doy + 273) %% 365 + 1
  } else {
    doy
  }
  # Convert the adjusted DOY to a date
  date <- as.Date(paste(2000, adjusted_doy), format = "%Y %j")
  # Return the month name
  return(format(date, "%b"))
}


#currently has reactive title and caption--removed for shiny, see app.r
fct_stars_survival_plot <- function(data, x_var, year, metric) {
  
  # Define y variable and ribbon variables based on metric
  y_var <- metric
  ymin_var <- paste0(metric, "L80")
  ymax_var <- paste0(metric, "U80")
  
        # Define title based on metric
  rct_title <- switch(metric,
                  surv = 'STARS model - Overall Survival',
                  idsurv = 'STARS model -Interior Delta Route-specific Survival Probability',
                  idRoute = 'STARS model - Interior Delta Route-specific Probability',
                  'STARS model - Survival')
  
    # Define title based on metric
  rct_caption <- switch(metric,
                  surv = "The solid line shows median survival of daily cohorts of winter run Chinook Salmon\n through the Delta from Knights Landing to Chipps Island for all routes combined.",
                  idsurv = "Route-specific survival of daily cohorts of winter run Chinook Salmon\nthrough the Delta from Knights Landing to Chipps Island.",
                  idRoute = "Proportion of daily cohorts of winter run Chinook Salmon\nthrough the Delta (Knights Landing to Chipps Island) using the Interior Delta route.")
  
          # Define title based on metric
  rct_x_var <- switch(x_var,
                  wDay =  'Month\n(Water Year: Oct-Dec of year [t-1], Jan-Sep of year [t])',
                  doy =  'Month\n(Calendar Year: Jan-Dec of year [t])')
  
   # Generate the labels for the x-axis
  labels <- sapply(seq(1, 365, by = 60), function(doy) doy_to_month(doy, year))
  
  
  
  # Plot
  p <- ggplot(data, aes_string(x = x_var, group = year)) +
    geom_line(aes_string(y = y_var)) +
    labs(x = rct_x_var,
         y = 'Probability',
         title = rct_title,
         subtitle = "Years of data : 2018 to 2024",
         #losing caption with plotly--see plotly annotation instead
         caption = rct_caption) +
    gghighlight(use_direct_label = FALSE) +
    facet_wrap(as.formula(paste0("~", year))) +
    geom_ribbon(aes_string(ymin = ymin_var, ymax = ymax_var), alpha = 0.5) +
    scale_x_continuous(breaks = seq(1, 365, by = 60), labels = labels) +
    # scale_x_continuous(breaks = seq(1, 365, by = 60), labels = day_to_month) +
    theme_minimal()

  p <- plotly::ggplotly(p)
  

p <- p %>%
  plotly::layout(
  autosize = F,
  margin = list(
    l = 50, # left margin
    r = 50, # right margin
    b = 100, # bottom margin
    t = 50, # top margin
    pad = 4 # padding
  )
  #annotation needs work -- if shiny or rmark easier to do outside plot
) %>% plotly::add_annotations(
  x = .65,
  y = -0.31,
  text = rct_caption,
  showarrow = F,
  xref = 'paper',
  yref = 'paper',
  xanchor = 'right',
  yanchor = 'auto',
  xshift = 0,
  yshift = 0,
  font = list(size = 10)
)
  
  return(p)
}

# Usage:
fct_stars_survival_plot(data = df_stars, x_var = "wDay", year = "WY", metric = "idRoute")
fct_stars_survival_plot(data = df_stars, x_var = "wDay", year = "WY", metric = "idsurv")
fct_stars_survival_plot(data = df_stars, x_var = "wDay", year = "WY", metric = "surv")
```

---

Issues: 

- Nick shared code to get latest STARs output. 

   - To have real-time generated data for shiny, we'll need to host in Linux server and have Susannah work her magic. Future update
   
- Determine best layout - possibly combine on one plot?

- Why are we highlighting one year compared to all years? Want to focus on current year compared to past years? Better way to approach?
   
- Include a shiny app to see hydrological year types? See `app.R` for basic shiny version
   
     - hoover label: best to just rename the datafile for geom_line() -- using tooltip was not working. Look into how to drop gghighlight tooltip
     
     - update to using aes versus aes_string somehow and be able to plot x_var-- see warning 
     
     - plotly size 

## Figure 3. Juvenile Production Estimate - Percent Loss 


```{r import_loss_data, include=FALSE}
#url <- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no"
url<- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=default&year=all&species=1%3Af&dnaOnly=no&age=no"

#filter to include only winter-run chinook for LAD or winter-run for DNA
loss.wch <- read.csv(url) %>%
  filter(LAD.Race == 'Winter'| DNA.Race == 'Winter') 
  
#adjust imported loss to WY 
df_loss <- loss.wch %>% select(Sample.Time, Facility, LAD.Race, DNA.Race, Length, nfish, Expanded.Salvage, Loss) %>%
  mutate(Date = as.Date(Sample.Time)) %>%
  arrange(Date) %>%
  mutate(WY = year(Date) + (month(Date) >= 10),
         wDay = if_else(month(Date) >= 10, yday(Date) - 273, yday(Date) + 92),
         doy = yday(Date),
         CY = year(Date),
         wDate = if_else(month(Date) >= 10, Date + years(1), Date))

#summarize loss to later calculate pct loss per LAD/DNA 
df_ladloss_sum<-df_loss %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise( nfish = sum (nfish),
             nloss = sum(Loss),
             nsalvage = sum(Expanded.Salvage))%>% 
  mutate(losstype = "LAD")

df_dnaloss_sum<-df_loss %>% 
  filter(DNA.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise( nfish = sum (nfish),
             nloss = sum(Loss),
             nsalvage = sum(Expanded.Salvage)) %>% 
  mutate(losstype = "DNA")

df_loss_sum <-rbind(df_ladloss_sum, df_dnaloss_sum)

#import JPE estimates
jpe_url<- "https://www.cbr.washington.edu/sacramento/data/graphics/jpedata_Natural_1.txt"
#assign WY for each letter (one year ahead of broodyear)
df_jpe<-read.csv(jpe_url, sep = "|") %>% 
  mutate(WY = brood_year + 1)

#join JPE totals with loss
df_jpe_loss_sum <- df_loss_sum %>% 
  inner_join(select(df_jpe,WY,brood_year, "method" = references_contributors,  "JPE" = value ), by = "WY" ) %>% 
  mutate(method = str_replace(method, "Method 2 .*", "Method 2 (O'Farrell et al., 2018)"))

df_pct_jpe_loss_sum<-df_jpe_loss_sum %>% 
  group_by(WY, losstype) %>% 
  mutate(pctloss = (nloss/JPE))
```


```{r import_loss_data, include=FALSE}



#Further filter to only plot winter-run chinook for LAD
cumulativeLAD <- df_loss %>% filter(LAD.Race == 'Winter') %>% group_by(WY) %>%
  mutate(cumloss = cumsum(Loss)) %>%
  #designate pre/post 2009 BiOp
  mutate(Status = case_when(WY < 2009 ~ 'Pre-2009 BiOp\n(1994 to 2008)',
                            WY > 2008 ~ '2009 & 2019 BiOp\n(2009 to present)')) %>%
  #set order of factor levels
  mutate(Status = factor(Status, levels = c('Pre-2009 BiOp\n(1994 to 2008)', '2009 & 2019 BiOp\n(2009 to present)'))) %>% 
  #join with wytype to designate wet/dry year (Hydrologic Classification Index?)
  left_join(select(wytype,WY, "hydro_type" = Yr.type) , by = 'WY') %>%
  #remove date na's
  filter(!is.na(Date)) %>%
  # #label historical versus current year
  # mutate(History = if_else(WY == '2024', 'Current', 'Past')) %>%
  #relabel wytype Yr.type to Wet/Dry -- add all?
  mutate( hydro_type = factor(hydro_type, levels = c("W", "AN", "BN", "D", "C"), labels = c("Wet", "Above Normal", "Below Normal", "Dry", "Critical")))

```

### Figure 3a. JPE percent loss {-}

```{r p_jpe_genetic_loss_pct, fig.width=10, echo = FALSE, warning = FALSE, message=FALSE}
#pull in JPES and genetic loss data
 JPE_Genetic_Loss_Comparison<- read_csv(here::here('track-a-cohort/shared files/JPE_Genetic_Loss_Comparison.csv'))


jpe_long <- JPE_Genetic_Loss_Comparison %>% 
  select(WaterYear,BroodYear,JuvenileProductionEstimate,PercentJPE_genetic,PercentJPE_LAD) %>% 
  # rename(`Juvenile Production Estimate`= JuvenileProductionEstimate,`Percent JPE Genetic Loss` = PercentJPE_genetic, `Percent JPE LAD Loss`= PercentJPE_LAD) %>% 
  pivot_longer(cols =PercentJPE_genetic:PercentJPE_LAD, names_to = "method", values_to = "value")



#bar plot of genetic and LAD loss
p_jpe_genetic_lad_barplot <- 
  ggplot(data=jpe_long, aes(x=as.factor(BroodYear), y= value, fill=method)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(title = "Genetic vs Length-At-Date (LAD) Historical Percent Loss of the JPE\n")+
  labs(x = "Brood Year", 
       y = "Percent of the JPE Lost", #change title
       fill = NULL) +
  scale_y_continuous(breaks = seq(0, 6, by = 2), limits = c(0, 6), expand = c(0, 0))+
  scale_fill_manual(values = c("black", "grey"),
                    labels = c("Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65), 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(), 
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"), 
          text = element_text(size = 15))

p_jpe_genetic_lad_barplot
```

### Figure 3b. Cumulative Loss {-}


---

Issues: 
- Fig 3: 

  - updating naming and source files (work with Susannah)

- Fig3a : 

  - uses 02_HistoricWRSalvageandLoss.R - Nick Bertrund's code

  - `JPE_Genetic_Loss_Comparison.csv` where is this data sourced from? Why wouldn't the genetic loss from url in `import_loss_data` match? OR why is an additional csv, `WRgenetic.csv` needed? Need one file and sum within-- too many random files 



## Figure 4. Juvenile Production Estimate - Total Number Lost

### Figure 4a
```{r p_jpe_genetic_loss_count, fig.width=10, echo = FALSE, warning=FALSE, message=FALSE}
#pull in JPES and genetic loss data
 JPE_Genetic_Loss_Comparison<- read_csv(here::here('track-a-cohort/shared files/JPE_Genetic_Loss_Comparison.csv'))


jpe_long <- JPE_Genetic_Loss_Comparison %>% 
  select(WaterYear,BroodYear,JuvenileProductionEstimate,LAD = WinterRun_LAD_Loss,Genetic = WinterRun_Genetic_Loss) %>% 
  # rename(`Juvenile Production Estimate`= JuvenileProductionEstimate,`Percent JPE Genetic Loss` = PercentJPE_genetic, `Percent JPE LAD Loss`= PercentJPE_LAD) %>% 
  pivot_longer(cols =LAD:Genetic, names_to = "method", values_to = "value")



#bar plot of genetic and LAD loss
p <- 
  ggplot(data=jpe_long, aes(x=as.factor(BroodYear), y= value, fill=method)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs(title = "Genetic vs Length-At-Date (LAD) Historical Number Lost of the JPE\n")+
  labs(x = "Brood Year", 
       y = "Number of Winter-run JPE lost", #change title
       fill = NULL) +
  scale_y_continuous(breaks = seq(0, 20000, by = 5000), limits = c(0, 20000), expand = c(0, 0))+
  scale_fill_manual(values = c("black","grey" ),
                    breaks = c("Genetic", "LAD"))+
  theme_minimal() +
    theme(legend.position = c(.9,.65), 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          panel.grid.major.x = element_blank(), 
          axis.line.x = element_line(color = "black", .5),
          axis.ticks.x = element_line(color = "black"), 
          text = element_text(size = 15))

p
```



### Figure 4b

Cumulative Loss


```{r fig3b_shared_code, eval=FALSE, include=FALSE}
url_orig <- 'https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no'
url <- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no"
loss <- read.csv(url) %>%
  filter(LAD.Race == 'Winter'| DNA.Race == 'Winter')

waterDay<-readRDS(here::here("track-a-cohort/shared files/waterDay.rds"))

wytype <- read.csv('track-a-cohort/shared files/WYtype.csv') %>% filter(Basin == "SacramentoValley") %>%mutate(TYPE = Yr.type)
loss <- loss %>% select(Date = 1, 2, 5, 6, 11, 12, ExpSalv = 13, 14) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(WY = get_fy(Date, opt_fy_start = '10-01')) %>%
  mutate(wDay = waterDay(Date))

cumulativeLAD <- loss %>% filter(LAD.Race == 'Winter') %>% group_by(WY) %>%
  mutate(cumloss = cumsum(Loss), cumsalvage = cumsum(ExpSalv), cumCount = cumsum(nfish)) %>%
  mutate(Status = case_when(WY < 2009 ~ 'Pre-2009 BiOp',
                            WY > 2008 ~ '2009 & 2019 BiOp')) %>%
  left_join(wytype, by = 'WY') %>%
  filter(!is.na(Date)) %>%
  mutate(History = if_else(WY == '2024', 'Current', 'Past')) %>%
  mutate(Type2 = if_else(TYPE %in% c('W', 'AN'), 'Wet', 'Dry')) %>%
  mutate(Status = factor(Status, levels = c('Pre-2009 BiOp', '2009 & 2019 BiOp')))


yearsLAD <- cumulativeLAD %>% group_by(WY, Status, TYPE, Type2) %>% summarize(Day = max(wDay), Loss = max(cumloss))
max2024LAD <- cumulativeLAD %>% filter(WY == 2024 & cumloss == max(cumloss)) %>% pull(cumloss)
loss2024LAD <- cumulativeLAD %>% filter(WY == 2024) %>% select(10, 11)
label2024 <- data.frame(x = 90, y = 1250, label = '2024')

WR <- ggplot() +
  geom_line(filter(cumulativeLAD, WY < 2024), 
            mapping = aes(x = wDay, y = cumloss, group = factor(WY)), color = 'grey', linewidth = 1)+
  geom_line(loss2024LAD, 
            mapping = aes(x = wDay, y = cumloss), color = 'steelblue2', linewidth = 1.5)+
  geom_text_repel(filter(yearsLAD, Loss > max2024LAD), mapping = aes(x = Day+1, y = Loss, label = WY), 
            size = 3, fontface = 'bold', alpha = 0.75, min.segment.length = .1) +
  facet_grid(Status ~ Type2) +
  labs(x = 'Date', y = 'Cumulative Loss', title = 'Winter-run Current and Historic Cumulative Salvage') +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  theme(plot.margin = margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=10)),
        axis.title.y = element_text(margin=margin(r=10)))
WR
```


```{r fig4_import_wrangle data, echo=FALSE, message=FALSE}
url <- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=csv&year=all&species=1%3Af&dnaOnly=no&age=no"
url2<- "https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=default&year=all&species=1%3Aall&dnaOnly=no&age=no"

#filter to include only winter-run chinook for LAD or winter-run for DNA
loss.wch <- read.csv(url) %>%
  filter(LAD.Race == 'Winter'| DNA.Race == 'Winter') 
  
#adjust imported loss to WY 
df_loss <- loss.wch %>% select(Sample.Time, Facility, LAD.Race, DNA.Race, Length, nfish, Expanded.Salvage, Loss) %>%
  mutate(Date = as.Date(Sample.Time)) %>%
  arrange(Date) %>%
  mutate(WY = year(Date) + (month(Date) >= 10),
         wDay = if_else(month(Date) >= 10, yday(Date) - 273, yday(Date) + 92),
         doy = yday(Date),
         CY = year(Date),
         wDate = if_else(month(Date) >= 10, Date + years(1), Date))

#pull in shared wytype.csv-- look to automate this process
wytype <- read_csv(here::here('track-a-cohort/shared files/WYtype.csv')) %>% filter(Basin == "SacramentoValley")

#Further filter to only plot winter-run chinook for LAD
cumulativeLAD <- df_loss %>% filter(LAD.Race == 'Winter') %>% group_by(WY) %>%
  mutate(cumloss = cumsum(Loss), cumCount = cumsum(nfish)) %>%
  #designate pre/post 2009 BiOp
  mutate(Status = case_when(WY < 2009 ~ 'Pre-2009 BiOp\n(1994 to 2008)',
                            WY > 2008 ~ '2009 & 2019 BiOp\n(2009 to present)')) %>%
  #set order of factor levels
  mutate(Status = factor(Status, levels = c('Pre-2009 BiOp\n(1994 to 2008)', '2009 & 2019 BiOp\n(2009 to present)'))) %>% 
  #join with wytype to designate wet/dry year (Hydrologic Classification Index?)
  left_join(select(wytype,WY, `Yr-type`) , by = 'WY') %>%
  #remove date na's
  filter(!is.na(Date)) %>%
  #label historical versus current year
  mutate(History = if_else(WY == '2024', 'Current', 'Past')) %>%
  #relabel wytype Yr.type to Wet/Dry -- add all?
  mutate(Type2 = if_else(`Yr-type` %in% c('W', 'AN'), 'Wet', 'Dry'))
  

  # yearsLAD <- cumulativeLAD %>% group_by(WY, Status, Yr-type, Type2) %>% summarize(Day = max(wDay), Loss = max(cumloss))
  # 
  # #extract values to then plot 2024 loss for all facets to compare years against
  # loss2024LAD <- cumulativeLAD %>% filter(WY == 2024) %>% select(WY, wDay)
  # label2024 <- data.frame(x = 90, y = 1250, label = '2024')
```

### Figure 4a. Current and Historical Cumulative Loss
```{r p_fig4a_all_years, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10}
#plot

# #set function to 2024?
# day_to_month <- function(day) {
#   month <- as.Date(paste(2024, day), format = "%Y %j") %>% format("%b")
#   return(month)
# }

#plot all years together  
p1<-cumulativeLAD %>% 
 ggplot() +
  # geom_line( aes(x = wDay, y = cumloss, group = WY, color = if_else(WY == 2024, "black", ifelse(Type2 == "Dry", "brown", "cadetblue3")),lwd = if_else(WY == 2024, .5, .05)))+
    geom_line( data = subset(cumulativeLAD, WY != 2024), aes(x=wDay, y = cumloss, group = WY, color = Type2), lwd = .25)+
  geom_line( data = subset(cumulativeLAD, WY == 2024), aes( x=wDay, y = cumloss, group = WY, linetype = as.factor(WY)), color = "black", lwd = 1)+
  labs(x = 'Date', 
       y = 'Cumulative Loss', 
       title = 'Winter-run Chinook salmon - Current and Historical Cumulative Salvage',
       subtitle = " Data includes: WY1994 to WY2024",
       color = "Hydrological Year Type:",
       linetype = "Current Water Year:") +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  # scale_x_continuous(breaks = seq(1, 365, by = 30.5), labels = day_to_month) +
  scale_y_continuous(breaks = seq(0, 20000, by = 5000), limits = c(0, 20000), expand = c(0, 0))+
  scale_color_manual(values = c("brown", "cadetblue3"), labels = c("Dry", "Wet"))+
   guides(linetype = guide_legend(order = 1), color = guide_legend(order = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(), 
        axis.line.x = element_line(color = "black", .5),
         axis.line.y = element_line(color = "black", .5),
        axis.ticks.x = element_line(color = "black"), 
        text = element_text(size = 15))
p1
```

### Figure 4a. Current and Historical Cumulative Loss by season type and BiOp year

```{r p_fig4b_facet, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8, fig.cap= "Black line represents all years above the current WY (2024) max cumulative loss and the brown/blue lines indicate dry and wet hydrological years, respectively. Dashed line represents the max cumulative loss in current water year: WY2024"}
#plot by dry/wet and pre/post 2009 BiOp

#extract max cumloss of 2024 to adjust color 
max2024LAD <- cumulativeLAD %>% 
  filter(WY == 2024) %>% 
  summarise(max_cumloss = max(cumloss)) %>% 
  pull(max_cumloss)

#extract maximum cumloss for each year (for labels)
max_cumloss_per_year <- cumulativeLAD %>%
  group_by(WY) %>%
  filter(cumloss == max(cumloss))

#Data frame that contains only the data for the year 2001 (for year labels excluding >10,000)
year2001_data <- cumulativeLAD %>% filter(WY == 2001, cumloss < 10000)

p2 <- cumulativeLAD %>%
  filter(cumloss < 10000) %>% 
  ggplot() +
  geom_line(aes(x = wDay, y = cumloss, group = WY, color = if_else(WY == 2024, "black", if_else(cumloss > max2024LAD, "black", if_else(Type2 == "Dry", "brown", "cadetblue3"))))) +
  geom_hline(yintercept = max2024LAD, linetype = "dashed", color = "black") +
  ggrepel::geom_text_repel(data = subset(max_cumloss_per_year, cumloss >= max2024LAD), aes(x = wDay, y = cumloss, label = WY), size = 3,  nudge_y = 10, nudge_x = 2) +
  geom_text(data = year2001_data, aes(x = 180, y = 9500, label = "*2001\nmax value = 20062"), size = 3,fontface = "plain") +
  labs(x = 'Date', 
       y = 'Cumulative Loss', 
       title = 'Winter-run Chinook salmon -  Current and Historical Cumulative Salvage',
       subtitle = "Data includes: WY1994 to WY2024") +
  scale_x_continuous(breaks = c(93,152,213,274), labels = c('Jan', 'Mar', 'May', 'Jul')) +
  scale_y_continuous(breaks = seq(0, 10000, by = 2000), limits = c(0, 10000), expand = c(0, 0)) +
  scale_color_identity() +
  ggh4x::facet_nested( ~ Status + Type2) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), 
        panel.border = element_rect(colour = "grey", fill=NA),
    axis.ticks.x = element_line(color = "black"), 
    text = element_text(size = 15))
p2



```

---

Questions: 

- query from : https://www.cbr.washington.edu/sacramento/data/query_loss_detail.html with all years, species, and no LAD age restriction, but  requires dna?

- filters to include winter for LAD OR winter for DNA, which also filters to include only chinook
  - could filter further to include only winter-run chinook for LAD and DNA diff or ~5700 to ~1700

- for some reason, the [url generated via query tool](https://www.cbr.washington.edu/sacramento/data/php/rpt/juv_loss_detail.php?sc=1&outputFormat=default&year=all&species=1%3Aall&dnaOnly=yes&age=no)  for all chinook, all years, and no LAD age restriction, but requires dna, does not return nearly as many records as the url generated by BOR. Will use theres for now-- look into why. 

- Uses WYtype.csv -- what is this data? Headers include: WY, Basin, Oct-Mar, Apr-Jul, WYsum, Index, Yr-type -- Yr-type seems to be designating dry/wet  year -- where can this be sourced? This information will be hosted on SacPas updated website June 2024. The data is pulling from [CDEC](https://cdec.water.ca.gov/reportapp/javareports?name=WSIHIST). Working with static file until I can update. 



## Figure 6. Cumulative loss by type with annual loss thresholds
```{r import_code_shared, eval=FALSE, include=FALSE}
library(tidyverse)
library(readr)
library(busdater)
library(patchwork)
library(rvest)
#set source folder, destination folder, and read in most recent salmon and steelhead files
#pulling in most recent steelhead salvage
url <- "https://filelib.wildlife.ca.gov/Public/salvage/Salmon%20Monitoring%20Team/" #salvage files url
page <- read_html(url) #read url in
links <- page %>% html_nodes("a") %>% html_attr("href") # Extract all links from the webpage
salmon_links <- links[grep("salmon_", links, ignore.case = TRUE)]  # Select files containing "salmon_"
salmon_links <- salmon_links[!grepl("summary", salmon_links, ignore.case = TRUE)]  # Exclude files containing "summary"
salmon_links <- salmon_links[!grepl("table", salmon_links, ignore.case = TRUE)] # Exclude files containing "table"
file <- max(grep("\\.csv$", salmon_links, value = TRUE, ignore.case = TRUE)) #isolate the most recent salmon salvage table

#read in salmon salvage file
salmon <- read.csv(paste0('https://filelib.wildlife.ca.gov/',file)) %>%
  mutate(SampleDate = as.Date(SampleDate))

#summarize genetic daily limit exceedance. Resulting table is Table 1.
daily_trigger <- salmon %>% filter(DNA_Race == 'W') %>%
  group_by(SampleDate) %>% summarize(Loss = sum(LOSS, na.rm = TRUE)) %>%
  mutate(Perc_JPE = (Loss/234896)*100) %>%
  mutate(Threshold = case_when(month(SampleDate) == 1 ~ .00124, #add in daily trigger limit by month
                              month(SampleDate) == 2 ~ .00231,
                              month(SampleDate) == 3 ~ .00372,
                              month(SampleDate) == 4 ~ .00226,
                              month(SampleDate) == 5 ~ 0)) %>%
  mutate(Trigger = if_else(Perc_JPE > Threshold, 'Y', 'N')) #check if genetic loss exceeds daily trigger


#filtering for LAD WR and Genetic WR and recombining into dataframe for graph
salmonLAD <- salmon %>% 
  filter(ADCLIP == 'N', Size_Race == 'W') %>%
  select(Date = 2,13) %>% 
  replace(is.na(.), 0) %>% 
  mutate(cumlost = cumsum(LOSS)) %>%
  mutate(Type = 'Length at Date')
salmonGen <- salmon %>%
  filter(ADCLIP == 'N', DNA_Race == 'W') %>%
  select(Date = 2,13) %>% 
  replace(is.na(.), 0) %>% 
  mutate(cumlost = cumsum(LOSS)) %>%
  mutate(Type = 'Genetic') %>% 
  bind_rows(tibble(Date = max(salmonLAD$Date), 
                   LOSS = max(.$LOSS),
                   cumlost = max(.$cumlost), 
                   Type = 'Genetic'))
salmonAll <- bind_rows(salmonLAD, salmonGen)

```


```{r import_salvage_data_cbr, eval=FALSE, include=FALSE}
#currently works off of link previously generated that pull all years of data-- this further filters to the current water year (i.e., CY =2024, pulls 10-1-23 to 9-30-24)

# Get the current year
current_year <- year(Sys.Date())

# Specify the start and end dates
start_date <- as.Date(paste0(current_year - 1, "-10-01"))
end_date <- as.Date(paste0(current_year, "-09-30"))

# extract JPE current loss year --needs automatiu
JPE_currentyear<-JPE_Genetic_Loss_Comparison %>% filter(WaterYear == current_year) %>% pull(JuvenileProductionEstimate)

# Filter the data
df_loss_current_year <- df_loss %>%
  filter(Date >= start_date & Date <= end_date) %>% 
  filter(DNA.Race == "Winter" | LAD.Race == "Winter")

# Calculate the daily trigger
df_trigger <- df_loss_current_year %>%
  group_by(Date) %>% summarize(loss = sum(Loss, na.rm = TRUE)) %>%
  #divide loss by current year JPE to get percent JPE loss
  mutate(pctJPE = (loss/JPE_currentyear)*100) %>%
  #where are these daily triggers being selected from?
  mutate(threshold = case_when(month(Date) == 1 ~ .00124, #add in daily trigger limit by month
                              month(Date) == 2 ~ .00231,
                              month(Date) == 3 ~ .00372,
                              month(Date) == 4 ~ .00226,
                              month(Date) == 5 ~ 0)) %>%
  #designate if genetic loss exceeds daily trigger
  mutate(trigger = if_else(pctJPE > threshold, 'Y', 'N')) 

#calculate cumulative loss for LAD and Genetic
df_lad<-df_loss_current_year %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(Date) %>% 
  summarise(sum.loss = sum(Loss)) %>% 
  mutate(cumloss = cumsum(sum.loss),
         type = "LAD")

df_dna<-df_loss_current_year %>% 
  filter(DNA.Race == "Winter") %>% 
  group_by(Date) %>% 
  summarise(sum.loss = sum(Loss)) %>% 
  mutate(cumloss = cumsum(sum.loss),
         type = "DNA")
  
 df_combined <- bind_rows(df_lad, df_dna) 

```
```{r set_thresholds, eval = FALSE, include=FALSE}
JPE_2024_02<-round(JPE_currentyear * .02) 

JPE_2024_1.3<-(sum(234896 + 49924 + 125038)/3)*.013

round(JPE_currentyear*.017)

#get greatest annual loss from 2010-2018:
max_lad_loss<-df_loss %>%
  filter(between(WY, 2010,2018)) %>% 
  filter(LAD.Race == "Winter") %>% 
  group_by(WY) %>% 
  summarise(annual_loss = sum(Loss)) %>%
  filter( annual_loss == max(annual_loss)) %>% 
  pull(annual_loss)*.9 #annual threshold is 90% the maximum annual loss from 2010-2018

4359.90	*.9
```
https://www.cbr.washington.edu/sacramento/workgroups/salmon_monitoring.html#:~:text=Natural%20Winter%2DRun%20Chinook%20Salmon%20Loss

```{r eval = FALSE, include=FALSE}
df_combined %>% 
  ggplot(aes(x = Date, y = cumloss)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  geom_hline(thresholdsLAD, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsLAD, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (LAD)', '75%', 
                                                      '100%', 'Single-year ITL (2% of JPE)')), 
            fontface = 'bold', vjust = 1.4, size = 3, color = '#333333', hjust=0) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3)
  facet_grid(~type)
  theme_minimal()
```

```{r shared_plot_code_1, eval=FALSE, include=FALSE}
#graph for LAD salmon
SalthresholdsLAD <- data.frame(Thresholds = c('50%', '75%', '100%', 'Single-year ITL (2% of JPE)'), values = c(1374, 2061, 2748, 4698))


salmonmax <- salmonAll %>% group_by(Type) %>% summarize(Date = max(Date), cumlost = max(cumlost))
Sal1 <- ggplot() + 
  geom_line(filter(salmonAll, Type == 'Length at Date'), 
            mapping = aes(x = Date, y = cumlost), 
            linewidth = 1,
            color = 'steelblue3') + 
  geom_hline(SalthresholdsLAD, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsLAD, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (LAD)', '75%', 
                                                      '100%', 'Single-year ITL (2% of JPE)')), 
            fontface = 'bold', vjust = 1.4, size = 3, color = '#333333', hjust=0) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3) +
  geom_label(filter(salmonmax, Type == 'Length at Date'), mapping = aes(x = Date + 1, y = cumlost+150,
                                                                        label = paste0(cumlost,
                                                                                       ' (',round(((cumlost/4698)*100),1),'%)')), size = 3) +
  labs(y = 'Cumulative Loss', x = 'Date', title = 'Winter-run LAD Loss') + 
  scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000, ceiling), 500)) +
  scale_x_date(date_breaks = '3 weeks', date_labels = "%b %d", limits = c(as.Date('2024-01-01'), Sys.Date() + 14)) +
  guides(linetype = FALSE) +
  theme(legend.position = 'none',
        plot.margin = margin(0.2,0.2,0.2,0.2, unit = 'cm'),
        axis.title.y = element_text(margin=margin(r=15), size = 15),
        axis.title.x = element_text(margin=margin(t=15), size = 15))
Sal1
```


```{r shared_plot_code_2, eval=FALSE, include=FALSE}
#graph for genetic salmon
SalthresholdsGen <- data.frame(Thresholds = c('50%', '75%', '100%'), values = c(592, 888, 1184))
salmonmax <- salmonAll %>% group_by(Type) %>% summarize(Date = max(Date), cumlost = max(cumlost))
Sal2 <- ggplot() + 
  geom_line(filter(salmonAll, Type == 'Genetic'), 
            mapping = aes(x = Date, y = cumlost), 
            linewidth = 1,
            color = 'steelblue3') + 
  geom_hline(SalthresholdsGen, mapping = aes(yintercept = values, 
                                             linetype = Thresholds), 
             linewidth = 0.5) + 
  geom_text(SalthresholdsGen, mapping = aes(x = as.Date(min(salmonAll$Date))-7, y = values, 
                                            label = c('50% Annual Loss Threshold (Genetic)', '75%', 
                                                      '100%')), 
            fontface = 'bold', vjust = 1.4, color = '#333333', hjust=0, size = 3) +
  geom_vline(aes(xintercept = as.Date('2024-03-11')), linewidth = 1, 
             linetype = 'dashed', color = 'darkgreen', alpha = 0.6) +
  geom_text(aes(x = as.Date('2024-03-10'), y = 4000, label = '-500 flow \n action'), 
            hjust = .95, fontface = 'bold', size = 3) +
  geom_label(filter(salmonmax, Type == 'Genetic'), mapping = aes(x = Date + 1, y = cumlost+150,
                                                                 label = paste0(cumlost,
                                                                                ' (',round(((cumlost/1184)*100),1),'%)')), size = 3) +
  labs(y = 'Cumulative Loss', title = 'Winter-run Genetic Loss') + 
  scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000), 100), limits = c(0, 1200)) +
  scale_x_date(date_breaks = '3 weeks', date_labels = "%b %d", limits = c(as.Date('2024-01-01'), Sys.Date() + 14)) +
  guides(linetype = FALSE) +
  theme(legend.position = 'none',
        plot.margin = margin(0.2,0.2,0.2,0.2, unit = 'cm'),
        axis.title.x = element_text(margin=margin(t=15), size = 15))
Sal2
```


```{r shared_plot_code_combined, eval=FALSE, include=FALSE}
WRGraph <- Sal1|(Sal2 +
                   theme(axis.text.y = element_blank(),
                         axis.title.y = element_blank()) +
                   scale_y_continuous(breaks = seq(0,plyr::round_any(max(SalthresholdsLAD$values), 1000), 500), 
                                      limits = c(0, max(SalthresholdsLAD$values))))
WRGraph #This is figure 7

```

```{r, eval = FALSE, include=FALSE}

thresholdsLAD <- data.frame(Thresholds = c('50%', '75%', '100%', 'Single-year ITL (2% of JPE)'), values = c(1374, 2061, 2748, 4698))
```


---

Questions:

- get JPE data source updated

- pull salvage loss and filter to current year 

- pull monthly daily triggers and update plot -- where are these daily triggers being selected from?

- Where are the threshold values being calculated. The 2% single year JPE represents: 
"Loss of natural winter-run Chinook salmon, is 1.3% of the JPE on a three-year rolling
average or 2.0% of the JPE in any single year." 

  - but where is the 100%, 75%, 50% coming from? 
  
  - And, why is there a difference for LAD versus genetic data threshold values?
    
    - https://www.cbr.washington.edu/sacramento/workgroups/salmon_monitoring.html#:~:text=Single%2DYear%20Loss%20Thresholds%20(PA,Salmon%20(loss%3D%201.17%25%20of%20JPE)
  
- What is the significance of the -500 flow action?
