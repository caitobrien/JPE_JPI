---
title: "LAD_assignment_working"
output: html_document
date: "2024-05-06"
---

Objective:
This markdown is focused on designating run assignment using Length-at-date (LAD) for juveniles passing Red Bluff Diversion Dam (RBDD) via R script. Both CBR and USFWS have shared Length-at-date run designation data. USFWS currently assigns run designation using a macro in Excel & Access but would like to automate via R. 

Data sources:

- CBR shared file: lengthcriteriariver.csv
- USFWS shared file: RunDesignation.csv
- EDI Data portal - RBDD : https://portal.edirepository.org/nis/mapbrowse?scope=edi&identifier=1365&revision=1
- SacPas LAD figures: https://www.cbr.washington.edu/sacramento/data/delta_salvage.html

Naming on SacPas LAD figures:

- Spring
- Fall
- Late-Fall
- Winter

Run designation naming: 
- lengthcriteriariver.csv:  "WL"    "WE"    "LFL"   "LFE"   "FL"    "FE"    "SL"    "SE"    "WL.1"  "WE.1"  "LFL.1" "LFE.1" "FL.1"  "FE.1"  "SL.1"  "SE.1" 

- RunDesignation.csv: "F", "L", "W", "S"

- catch.csv: "fall run", "late fall run", "spring run", "winter run", "not reported"

To do: 

- get naming designations from SI

- current function assigns response base on presence/absence of date and length. Catch.csv data has run designation for catch_id's with length data. Find methods (likely in macros) to determine how this is designated. 

- Double check method is matching run assingment in catch.csv

- Compare CBR method to USFWS method


```{r load_libraries}
library(tidyverse)
library(here)
```

```{r load_data}
## load LAD designations from CBR and USFWS
lad_cbr <- read.csv(here::here("JPI_convert_to_Rcode/data","lengthcriteriariver.csv"))
lad_usfws_raw <- read.csv(here::here("JPI_convert_to_Rcode/data","RunDesignation.csv"))
lad_fws <- lad_usfws_raw %>% select(2:7)

## load catch.csv from EDI Data portal
# Define the URL by selecting link from EDI Data portal -- catch.csv
url <- "https://portal.edirepository.org/nis/dataviewer?packageid=edi.1365.1&entityid=58540ac4ed34ce05f3309510f4be91e5"

# Download and read the CSV file into a data frame
df_catch_raw <- read.csv(url)
```


```{r wrangle_data}
#wragle fws to match cbr format
lad_fws<-lad_fws %>% 
 tidyr::separate(LookupDate, into = c("mm", "dd"), sep = "/") %>% 
  mutate(mm = as.numeric(mm),
         dd = as.numeric(dd)) %>% 
 mutate(RunDesignation = recode( RunDesignation, 
         "L" =  "late_fall",
         "F" = 'fall',
         "W" = "winter",
         "S" = "spring"))

#wrangle cbr to match fws format
lad_cbr_long <- lad_cbr %>% 
  mutate(across(c("WL", "WE"), as.character)) %>% 
  pivot_longer(
    cols = -c(MONTH, DAY),
    names_to = c("RunDesignation", "min_max", "suffix"),
    names_pattern = "(.*)(L|E)(\\.1)?",
    names_repair = "minimal"
  ) %>% 
  mutate(value = as.integer(value)) %>% 
  pivot_wider(names_from = c(min_max, suffix), 
              values_from = value) %>% 
  rename(MinLength1 = L_, 
         MaxLength1 = E_, 
         MinLength2 = L_.1, 
         MaxLength2 = E_.1, 
         mm = MONTH, 
         dd = DAY) %>% 
  replace_na(list(MinLength1 = 0, MaxLength1 = 0, MinLength2 = 0, MaxLength2 = 0)) %>% 
   mutate(RunDesignation = recode( RunDesignation, 
         "LF" =  "late_fall",
         "F" = 'fall',
         "W" = "winter",
         "S" = "spring"))


#filter catch.csv to chinook salmon
df_catch <- df_catch_raw %>% 
  filter(common_name == "Chinook Salmon") %>%
  mutate(start_date = lubridate::ymd(start_date)) %>% 
  select(catch_id,common_name, start_date, fork_length, count, run) %>% 
   mutate(run = recode( run, 
         "late fall run" =  "late_fall",
         "fall run" = 'fall',
         "winter run" = "winter",
         "spring run" = "spring",
         "not reported" = "not reported"))

#remove unneeded data  
rm(df_catch_raw)
rm(lad_cbr)
rm(lad_usfws_raw)
```


```{r fct_LAD_designation}
# Function to assign run designation based on LAD data
#lad_data should be formatted with mm dd as numeric columns
#catch_data should have start_date as a date column and fork_length as a numeric column

fct_LAD_designation <- function(lad_data, catch_data){
  
 # Extract the month and day from the start_date column in catch.csv
  catch_data <- catch_data %>%
    mutate(start_date = lubridate::ymd(start_date),
           mm = lubridate::month(start_date),
           dd = lubridate::day(start_date))
 
   # Filter lad_data based on the month, day, and fork_length in catch.csv
  catch_data %>%
    rowwise() %>% 
    mutate(run_designation =  {
      if (is.na(start_date) & is.na(fork_length)) {
        "No length or date"
      } else if (is.na(start_date) & !is.na(fork_length)) {
        "No date"
      } else if (!is.na(start_date) & is.na(fork_length)) {
        "No length"
      } else {
        matches <- lad_data$RunDesignation[
          lad_data$mm == mm & lad_data$dd == dd & 
          ((fork_length >= lad_data$MinLength1 & fork_length <= lad_data$MaxLength1) | 
           (fork_length >= lad_data$MinLength2 & fork_length <= lad_data$MaxLength2))
        ]
        if (length(matches) == 0) {
          "no run designated"
        } else {
          paste(matches, collapse = ", ")
        }
      }
    })
}



#check designations
df_catch_designation_fws <- fct_LAD_designation(lad_data = lad_fws, catch_data = df_catch)
df_catch_designation_cbr <- fct_LAD_designation(lad_data = lad_cbr_long, catch_data = df_catch)

#save data
 # save(df_catch_designation_fws, file =here::here("JPI_convert_to_Rcode/data","catch_run_designation_fws.rda"), compress = "xz")
  
 # save(df_catch_designation_cbr, file =here::here("JPI_convert_to_Rcode/data","catch_run_designation_cbr.rda"), compress = "xz")

```


```{r compare_LAD_designation}
# Join the data frames
df_join <- df_catch_designation.fws %>%
  select(mm, dd, fork_length, run, run_designation_fws = run_designation) %>%
 cbind(run_designation_cbr = df_catch_designation.cbr$run_designation)

# Filter the rows where run, run_designation_fws and run_designation_cbr are not the same
df_different_runs <- df_join %>%
  filter(run != run_designation_fws | run != run_designation_cbr | run_designation_fws != run_designation_cbr)

# Filter the rows where run_designation_fws and run_designation_cbr are not the same
df_different_runs_cbr.fws <- df_join %>%
  filter( run_designation_fws != run_designation_cbr)

```

